<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=chrome" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stazione Meteo</title>
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/26c5.svg">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #103c60;
      color: white;
      text-align: center;
    }
    .image-container {
      position: relative;
      width: 100%;
      height: 25vh;
      overflow: hidden;
    }
    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-container .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1;
    }
    .image-container h1 {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 8vw;
      font-weight: bold;
      font-family: 'Comic Sans MS', sans-serif;
      z-index: 2;
      padding: 0 10px;
      margin: 0;
      width: auto;
      max-width: 90%;
      white-space: nowrap;
    }
    .hamburger {
      display: block;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 8vw;
      cursor: pointer;
      z-index: 3;
      color: white;
    }
    .navbar {
      background-color: #222;
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100%;
      padding: 10px 0;
      z-index: 2;
    }
    .navbar.show {
      display: flex;
    }
    .navbar a {
      color: white;
      text-decoration: none;
      font-size: 6vw;
      font-weight: bold;
      font-family: 'Comic Sans MS', sans-serif;
      padding: 10px;
      display: block;
    }
    .navbar a:hover {
      background-color: #ddd;
      color: black;
    }
    .content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px 10px;
      font-size: 5vw;
      text-align: center;
    }
    .monitoraggio-title {
      color: #ffffff;
      font-size: 6vw;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      width: 100%;
    }
    .aggiornamento-info {
      color: #cccccc;
      font-size: 3.5vw;
      margin-bottom: 20px;
      font-style: italic;
    }
    .misure {
      text-align: left;
      display: inline-block;
      margin-bottom: 30px;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 600px;
    }
    .grafico-section {
      width: 100%;
      margin: 30px 0;
    }
    .grafico-title {
      color: #ffffff;
      font-size: 5vw;
      margin-bottom: 25px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    .grafico-container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto 40px auto;
      background-color: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    .grafico-header {
      background: linear-gradient(135deg, #103c60, #1e5799);
      color: white;
      padding: 15px;
      border-radius: 10px 10px 0 0;
      margin: -25px -25px 20px -25px;
    }
    .grafico-header h4 {
      margin: 0;
      font-size: 5vw;
      font-weight: bold;
    }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
    footer {
      position: static;
      margin-top: 40px;
      text-align: center;
      padding: 20px;
      background-color: #0a2a4d;
      color: white;
      font-size: 4vw;
    }
    @media (min-width: 768px) {
      .hamburger { display: none; }
      .navbar {
        display: flex !important;
        flex-direction: row;
        justify-content: center;
      }
      .navbar a {
        font-size: 30px;
        padding: 6px 10px;
        display: inline-block;
      }
      .image-container { height: 250px; }
      .image-container h1 {
        font-size: 62px;
        padding: 0;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: auto;
        max-width: 90%;
        white-space: nowrap;
      }
      .content { 
        font-size: 20px;
        padding: 30px 20px;
      }
      .monitoraggio-title {
        font-size: 32px;
      }
      .aggiornamento-info {
        font-size: 16px;
      }
      .misure {
        font-size: 18px;
        padding: 25px;
      }
      .grafico-title {
        font-size: 28px;
        margin-bottom: 30px;
      }
      .grafico-header h4 {
        font-size: 22px;
      }
      footer { 
        font-size: 16px;
        padding: 25px;
      }
      canvas {
        height: 350px !important;
      }
    }
  </style>
</head>
<body>
  <div class="image-container">
    <img src="meteo.jpg" alt="Stazione Meteo" />
    <div class="overlay"></div>
    <h1>Stazione Meteo</h1>
    <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
  </div>

  <div class="navbar" id="navbar">
    <a href="index.html">üè†</a>
    <a href="stazione_meteo.html">‚õÖ</a>
    <a href="archivio.html">üìÅ</a>
    <a href="contatti.html">üì¨</a>
  </div>

  <div class="content">
    <section>
      <h3 class="monitoraggio-title">Monitoraggio in Tempo Reale</h3>
      <p class="aggiornamento-info">Dati aggiornati ogni 15 minuti</p>
      
      <div class="misure" id="misure">
        <p>Caricamento dati in corso...</p>
      </div>
    </section>

    <section class="grafico-section">
      <h3 class="grafico-title">Grafici Dati Meteo</h3>
      
      <div class="grafico-container">
        <div class="grafico-header">
          <h4>üìä Temperatura e Umidit√† - Oggi</h4>
        </div>
        <canvas id="graficoOggi"></canvas>
      </div>
      
      <div class="grafico-container">
        <div class="grafico-header">
          <h4>üìà Pressione Atmosferica - Oggi</h4>
        </div>
        <canvas id="graficoPressione"></canvas>
      </div>
      
      <div class="grafico-container">
        <div class="grafico-header">
          <h4>üìÖ Medie Ultimi 7 Giorni</h4>
        </div>
        <canvas id="graficoMedia"></canvas>
      </div>
    </section>

    <section>
      <ul style="text-align:left; display:inline-block;">
        <p>Sensori utilizzati nella stazione meteo:</p>
        <li>
          Bosh BMP280 Digital pressure & temperature sensor
          <ul>
            <p>| Pressione |</p>
            <p>Range: 0 - 20000 hPa</p>
            <p>Accuratezza assoluta: ¬±1.7 hPa (-20 - 0 ‚ÑÉ) | ¬±1.0 hPa (0 - 65 ‚ÑÉ)</p>
            <p>| Temperatura |</p>
            <p>Range: -45 - +85 ‚ÑÉ</p>
            <p>Accuratezza assoluta: ¬±0.5 ‚ÑÉ (@25‚ÑÉ) | ¬±1.0 ‚ÑÉ (0 - 65 ‚ÑÉ)</p>
            <p>| Umidit√† |</p>
            <p>Range: 0-100%</p>
            <p>Accuratezza assoluta: ¬±3%</p>
            <p>| Altitudine |</p>
            <p>Range: 0-9000 m</p>
            <p>Accuratezza assoluta: ¬±1 m</p>
          </ul>
        </li>
        <li>
          PMS7003 Digital universal particle concentration sensor
          <ul>
            <p>| PPM |</p>
            <p>Range: 0.3~1.0Ôºõ1.0~2.5Ôºõ2.5~10 Œºm</p>
            <p>Accuratezza assoluta: ¬±10% (100 - 500 Œºg/m¬≥) | ¬±10 Œºg/m¬≥ (0 - 100 Œºg/m¬≥)</p>
            <p>MTTF: ‚â• 3 Anni (Primo avvio Agosto 2025)</p>
          </ul>
        </li>
      </ul>
    </section>
  </div>

  <footer>
    <p>üì° Stazione Meteo - Coded by Grillo Edoardo</p>
  </footer>

  <script>
    function toggleMenu() {
      const navbar = document.getElementById('navbar');
      navbar.classList.toggle('show');
    }

    let chartOggi = null;
    let chartPressione = null;
    let chartMedia = null;

    // Configurazione tema bianco per tutti i grafici
    const chartOptionsWhite = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#000000',
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        },
        title: {
          display: false
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#000000',
            font: {
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          },
          title: {
            display: true,
            text: 'Orario di Misurazione',
            color: '#000000',
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        },
        y: {
          ticks: {
            color: '#000000',
            font: {
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          },
          title: {
            display: true,
            color: '#000000',
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        }
      }
    };

    function calcolaMedia(array) {
      if (array.length === 0) return 0;
      const sum = array.reduce((a, b) => a + b, 0);
      return (sum / array.length).toFixed(1);
    }

    function creaGraficoOggi(datiOggi, orariReali) {
      const ctx = document.getElementById('graficoOggi').getContext('2d');
      
      if (chartOggi) {
        chartOggi.destroy();
      }

      chartOggi = new Chart(ctx, {
        type: 'line',
        data: {
          labels: orariReali,
          datasets: [
            {
              label: 'Temperatura (¬∞C)',
              data: datiOggi.temperature,
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              tension: 0.4,
              fill: false,
              borderWidth: 3
            },
            {
              label: 'Umidit√† (%)',
              data: datiOggi.umidita,
              borderColor: 'rgb(54, 162, 235)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              tension: 0.4,
              fill: false,
              borderWidth: 3
            }
          ]
        },
        options: {
          ...chartOptionsWhite,
          scales: {
            ...chartOptionsWhite.scales,
            y: {
              ...chartOptionsWhite.scales.y,
              title: {
                display: true,
                text: 'Valori',
                color: '#000000'
              }
            }
          }
        }
      });
    }

    function creaGraficoPressione(datiOggi, orariReali) {
      const ctx = document.getElementById('graficoPressione').getContext('2d');
      
      if (chartPressione) {
        chartPressione.destroy();
      }

      chartPressione = new Chart(ctx, {
        type: 'line',
        data: {
          labels: orariReali,
          datasets: [
            {
              label: 'Pressione (hPa)',
              data: datiOggi.pressione,
              borderColor: 'rgb(75, 192, 192)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              tension: 0.4,
              fill: false,
              borderWidth: 3
            }
          ]
        },
        options: {
          ...chartOptionsWhite,
          scales: {
            ...chartOptionsWhite.scales,
            y: {
              ...chartOptionsWhite.scales.y,
              title: {
                display: true,
                text: 'Pressione (hPa)',
                color: '#000000'
              }
            }
          }
        }
      });
    }

    function creaGraficoMedia(storico) {
      const ctx = document.getElementById('graficoMedia').getContext('2d');
      
      if (chartMedia) {
        chartMedia.destroy();
      }

      const giorni = Object.keys(storico).sort();
      const medieTemp = giorni.map(giorno => calcolaMedia(storico[giorno].temperature));
      const medieUmid = giorni.map(giorno => calcolaMedia(storico[giorno].umidita));

      // Formatta le date in italiano (GG/MM/AA)
      const labels = giorni.map(data => {
        const [anno, mese, giorno] = data.split('-');
        return `${giorno}/${mese}/${anno.slice(2)}`;
      });

      chartMedia = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Temperatura Media (¬∞C)',
              data: medieTemp,
              borderColor: 'rgb(255, 159, 64)',
              backgroundColor: 'rgba(255, 159, 64, 0.2)',
              tension: 0.4,
              fill: false,
              borderWidth: 3
            },
            {
              label: 'Umidit√† Media (%)',
              data: medieUmid,
              borderColor: 'rgb(153, 102, 255)',
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              tension: 0.4,
              fill: false,
              borderWidth: 3
            }
          ]
        },
        options: {
          ...chartOptionsWhite,
          scales: {
            ...chartOptionsWhite.scales,
            x: {
              ...chartOptionsWhite.scales.x,
              title: {
                display: true,
                text: 'Data',
                color: '#000000'
              }
            },
            y: {
              ...chartOptionsWhite.scales.y,
              title: {
                display: true,
                text: 'Valori Medi',
                color: '#000000'
              }
            }
          }
        }
      });
    }

    async function aggiornaMeteo() {
      try {
        // Carica dati correnti
        const responseDati = await fetch('dati.json?_=' + new Date().getTime());
        if (!responseDati.ok) throw new Error('Errore caricamento dati correnti');
        const dati = await responseDati.json();
        
        // Carica storico
        const responseStorico = await fetch('storico.json?_=' + new Date().getTime());
        const storico = responseStorico.ok ? await responseStorico.json() : {};
        
        const oggi = new Date().toISOString().split('T')[0];
        const datiOggi = storico[oggi] || { temperature: [], umidita: [], pressione: [], altitudine: [], orari: [], conteggio: 0 };
        
        // Aggiorna HTML
        document.getElementById('misure').innerHTML = `
          <ul style="text-align:left; display:inline-block;">
            <p>üïí Misure all'orario: <strong>${dati.orario || 'N/A'}</strong></p>
            <p>üìä Pressione: <strong>${dati.pressione ? dati.pressione + ' hPa' : 'N/A'}</strong></p>
            <p>üå°Ô∏è Temperatura: <strong>${dati.temperatura ? dati.temperatura + ' ¬∞C' : 'N/A'}</strong></p>
            <p>üíß Umidit√†: <strong>${dati.umidita ? dati.umidita + ' %' : 'N/A'}</strong></p>
            <p>‚õ∞Ô∏è Altitudine: <strong>${dati.altitudine ? dati.altitudine + ' m' : 'N/A'}</strong></p>
            <p>üå´Ô∏è PPM <1.0: Dato non disponibile</p>
            <p>üå´Ô∏è PPM 2.5: Dato non disponibile</p>
            <p>üå´Ô∏è PPM 10: Dato non disponibile</p>
          </ul>
        `;
        
        // Prepara gli orari reali per i grafici
        const orariReali = datiOggi.orari || Array.from({length: datiOggi.temperature.length}, (_, i) => {
          // Se non ci sono orari salvati, crea orari approssimativi
          const now = new Date();
          const ore = now.getHours();
          const minuti = now.getMinutes() - (i * 15);
          return `${ore.toString().padStart(2, '0')}:${Math.max(0, minuti).toString().padStart(2, '0')}`;
        });
        
        // Crea grafici solo se ci sono dati
        if (datiOggi.temperature.length > 0) {
          creaGraficoOggi(datiOggi, orariReali);
        } else {
          document.getElementById('graficoOggi').innerHTML = '<p style="color: #000; padding: 20px;">Nessun dato disponibile per oggi</p>';
        }
        
        if (datiOggi.pressione.length > 0) {
          creaGraficoPressione(datiOggi, orariReali);
        } else {
          document.getElementById('graficoPressione').innerHTML = '<p style="color: #000; padding: 20px;">Nessun dato pressione disponibile</p>';
        }
        
        if (Object.keys(storico).length > 0) {
          creaGraficoMedia(storico);
        } else {
          document.getElementById('graficoMedia').innerHTML = '<p style="color: #000; padding: 20px;">Nessun dato storico disponibile</p>';
        }
        
      } catch (error) {
        console.error('Errore:', error);
        document.getElementById('misure').innerHTML = `
          <p style="color: red;">Errore nel caricamento dei dati meteo</p>
          <p>${error.message}</p>
        `;
      }
    }

    // Aggiorna i dati al caricamento della pagina
    document.addEventListener('DOMContentLoaded', function() {
      aggiornaMeteo();
      setInterval(aggiornaMeteo, 60000); // Aggiorna ogni minuto
    });
  </script>
</body>
</html>
